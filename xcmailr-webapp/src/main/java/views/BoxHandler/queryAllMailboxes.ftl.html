<#import "../layout/defaultLayout.ftl.html" as layout> <@layout.xcLayout title=i18n("editUser_Title")>
	<#include "../layout/header.ftl.html"/>
	
	<div style="margin-bottom: 20px;">${i18n("inbox.contentwarning")}<br /></div>
	<div class="container">
		<table
            id="mailbox"
		    data-pagination="true"
		    data-side-pagination="server" 
	        data-id-field="id"
	        data-toggle="table"
	        data-locale="${i18n("locale")}"
	        data-url="/mails?format=json">
		    <thead>
		        <tr>
		        	<th data-field="receivedTimeAsString">${i18n("inbox.receivedate_label")}</th>
		        	<th data-field="sender">${i18n("inbox.email_sender_label")}</th>
		        	<th data-field="mailAddress">${i18n("inbox.receiving_address_label")}</th>
		        	<th data-field="subject">${i18n("inbox.subject")}</th>
		        </tr>
		    </thead>
		</table>
		
		<div id="mail-content" style="display: none;">
			<span><b>${i18n("inbox.attachments_label")}: </b></span>
			<div class="attachments">
			</div>
			<br />
			<span><b>${i18n("inbox.subject")}: </b><span class="subject"></span></span>
			<br />
			<br />
			<span><b>${i18n("inbox.text_content_label")}</b></span>
			<pre class="text-content"></pre>
			<br />
			<span><b>${i18n("inbox.html_content_label")}</b></span>
			<pre class="html-content" style="position: relative; width: 100%; height: 0; padding-bottom: 100%;">
			  <iframe id="iframe-html-content" class="iframe" style="border:none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
			  </iframe>
			</pre>
		</div>
	</div>
	<script>
		$('#mailbox')
		.on('click-row.bs.table', function(row, element) {
			console.log(row, element);
			
			$('#mail-content .subject').html(element.subject);
			$('#mail-content .text-content').html(atob(element.textContent));
			
			$('#iframe-html-content').ready(function(){
       			$('#iframe-html-content').contents().find('body').html(atob(element.htmlContent));
    		});
    		
    		if (element.attachments.length > 0) {
    			$('#mail-content .attachments ul').remove();
    			$('<ul></ul>').appendTo('#mail-content .attachments');
    			for (let i = 0; i < element.attachments.length; i++) {
    				let attachment = element.attachments[i];
    				$('<li><a href=download/' + element.downloadToken + '/' + attachment.name + '>' + attachment.name + ' (' + humanreadableBytes(attachment.size) + ')</a></li>').appendTo('#mail-content .attachments ul');
    			}	
    		}
    		
			$('#mail-content').show();
		});
		
		$('#mailbox').on('click-row.bs.table', function(e, row, $element) {
			$element.addClass('active').siblings().removeClass('active');
		});
		
		// modified version of https://stackoverflow.com/questions/4498866/actual-numbers-to-the-human-readable-values
		function humanreadableBytes(bytes) {
 			var s = ['Bytes', 'KiB', 'MiB', 'GiB'];
    		var e = Math.floor(Math.log(bytes) / Math.log(1024));
    		return (bytes / Math.pow(1024, e)).toFixed(2) + " " + s[e];
		}
	</script>
</@layout.xcLayout>